<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Risk Wiki</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
</head>
<body>
    <div class="container" id="app">
        <div id="auth-section" style="text-align: right; padding: 10px 0; border-bottom: 1px solid #e1e8ed; margin-bottom: 20px;">
            <span id="user-info"></span>
        </div>
        <div id="content">
            Loading...
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { firebaseConfig } from './firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let editor = null;

        // Configure marked to preserve paragraphs
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // Helper to convert single line breaks to double (for proper paragraphs)
        function formatMarkdown(text) {
            // Split by double line breaks (existing paragraphs)
            const paragraphs = text.split(/\n\n+/);

            // For each paragraph, replace single line breaks with spaces
            // unless it's a list, heading, or other special markdown
            return paragraphs.map(para => {
                // Don't touch lists, headings, code blocks, etc.
                if (para.match(/^[\s]*[-*+]\s/) || // unordered lists
                    para.match(/^[\s]*\d+\.\s/) ||  // ordered lists
                    para.match(/^#{1,6}\s/) ||      // headings
                    para.match(/^```/) ||            // code blocks
                    para.match(/^>/) ) {             // blockquotes
                    return para;
                }
                // For normal text, replace single newlines with spaces
                return para.replace(/\n/g, ' ');
            }).join('\n\n');
        }

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateAuthUI();
        });

        function updateAuthUI() {
            const userInfo = document.getElementById('user-info');
            if (currentUser) {
                userInfo.innerHTML = `
                    <span>${currentUser.email}</span>
                    <button id="logout-btn" style="margin-left: 10px;">Logout</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    await signOut(auth);
                });
            } else {
                userInfo.innerHTML = `
                    <button id="login-btn">Login</button>
                `;
                document.getElementById('login-btn').addEventListener('click', showLoginPage);
            }
        }

        function showLoginPage() {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="auth-page" style="max-width: 400px; margin: 60px auto; text-align: center;">
                    <h1 style="margin-bottom: 30px; color: #333;">Login to AI Risk Wiki</h1>
                    <div class="auth-form" style="background: #f9f9f9; padding: 30px; border-radius: 8px; border: 1px solid #e1e8ed;">
                        <button id="google-login-btn" style="width: 100%; padding: 12px; margin-bottom: 20px; font-size: 16px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                            Sign in with Google
                        </button>
                        <div style="margin: 25px 0; position: relative;">
                            <hr style="border: none; border-top: 1px solid #ddd;">
                            <span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #f9f9f9; padding: 0 10px; color: #666; font-size: 14px;">or</span>
                        </div>
                        <input type="email" id="email" placeholder="Email" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; box-sizing: border-box;">
                        <input type="password" id="password" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; box-sizing: border-box;">
                        <button id="email-login-btn" style="width: 100%; padding: 12px; margin-bottom: 10px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 15px; font-weight: 500;">Login with Email</button>
                        <button id="email-signup-btn" style="width: 100%; padding: 12px; background: white; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 15px;">Sign Up with Email</button>
                        <p id="auth-error" style="color: #e53e3e; margin-top: 15px; font-size: 14px;"></p>
                    </div>
                    <p style="margin-top: 20px;"><a href="#/" style="color: #3498db; text-decoration: none;">← Back to homepage</a></p>
                </div>
            `;

            document.getElementById('google-login-btn').addEventListener('click', async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                    window.location.hash = '/';
                } catch (error) {
                    document.getElementById('auth-error').textContent = error.message;
                }
            });

            document.getElementById('email-login-btn').addEventListener('click', async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    window.location.hash = '/';
                } catch (error) {
                    document.getElementById('auth-error').textContent = error.message;
                }
            });

            document.getElementById('email-signup-btn').addEventListener('click', async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    window.location.hash = '/';
                } catch (error) {
                    document.getElementById('auth-error').textContent = error.message;
                }
            });
        }

        // Simple router
        async function route() {
            const hash = window.location.hash.slice(1) || '/';
            const contentDiv = document.getElementById('content');

            if (hash === '/' || hash === '') {
                await showHomepage(contentDiv);
            } else if (hash.startsWith('/risk/')) {
                const parts = hash.split('/');
                const riskId = parts[2];
                if (parts[3] === 'edit') {
                    await showEditRisk(contentDiv, riskId);
                } else {
                    await showRisk(contentDiv, riskId);
                }
            } else if (hash.startsWith('/tag/')) {
                const tag = decodeURIComponent(hash.split('/tag/')[1]);
                await showTagPage(contentDiv, tag);
            } else if (hash === '/edit-homepage') {
                await showEditHomepage(contentDiv);
            } else if (hash === '/new-risk') {
                await showNewRisk(contentDiv);
            } else {
                contentDiv.innerHTML = '<h1>404 - Page Not Found</h1>';
            }
        }

        // Show homepage with list of risks
        async function showHomepage(contentDiv) {
            contentDiv.innerHTML = '<p>Loading risks...</p>';

            try {
                const risksSnapshot = await getDocs(collection(db, 'risks'));
                const risks = [];

                risksSnapshot.forEach((doc) => {
                    risks.push({ id: doc.id, ...doc.data() });
                });

                // Sort by order
                risks.sort((a, b) => a.order - b.order);

                // Get homepage content
                const homepageDoc = await getDoc(doc(db, 'pages', 'homepage'));
                let introduction = 'There are so many causes or sources of AI risk that it\'s getting hard to keep them all in mind. I propose we keep a list of the main sources (that we know about), such that we can say that if none of these things happen, then we\'ve mostly eliminated AI risk (as an existential risk) at least as far as we can determine.';

                if (homepageDoc.exists()) {
                    introduction = homepageDoc.data().introduction;
                }

                let html = `
                    <header>
                        <h1>The Main Sources of AI Risk</h1>
                        <div class="authors">
                            by <a href="https://www.lesswrong.com/users/daniel-kokotajlo" target="_blank">Daniel Kokotajlo</a>,
                            <a href="https://www.lesswrong.com/users/wei_dai" target="_blank">Wei Dai</a>
                        </div>
                        <div class="meta">
                            <span class="date">21st Mar 2019</span>
                            <span class="separator">•</span>
                            <span class="source">AI Alignment Forum</span>
                        </div>
                        ${currentUser ? '<p style="text-align: right;"><a href="#/edit-homepage">Edit this page</a> | <a href="#/new-risk">Add New Risk</a></p>' : ''}
                    </header>

                    <section class="introduction">
                        <div>${marked.parse(formatMarkdown(introduction))}</div>
                    </section>

                    <section class="risk-list">
                        <ol class="risks">
                `;

                risks.forEach(risk => {
                    html += `
                        <li class="risk-item">
                            <a href="#/risk/${risk.id}">${risk.title}</a>
                        </li>
                    `;
                });

                html += `
                        </ol>
                    </section>

                    <section class="note">
                        <p><strong>Note:</strong> This list isn't fully disjunctive (i.e., some of the items are subcategories or causes of others). Items were given their own number if it seemed important to make that source more salient. The list emphasizes the <strong>disjunctive nature of AI risk</strong> - we need to address many different potential failure modes.</p>
                    </section>

                    <footer>
                        <p><em>Edit on 1/28/2020: This list was created by Wei Dai. Daniel Kokotajlo offered to keep it updated and prettify it over time, and so was added as a coauthor.</em></p>
                        <p>
                            Original post: <a href="https://www.alignmentforum.org/posts/WXvt8bxYnwBYpy9oT/the-main-sources-of-ai-risk" target="_blank">AI Alignment Forum</a>
                        </p>
                    </footer>
                `;

                contentDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading risks:', error);
                contentDiv.innerHTML = '<p>Error loading risks. Check console for details.</p>';
            }
        }

        // Show individual risk
        async function showRisk(contentDiv, riskId) {
            contentDiv.innerHTML = '<p>Loading risk...</p>';

            try {
                const riskDoc = await getDoc(doc(db, 'risks', riskId));

                if (!riskDoc.exists()) {
                    contentDiv.innerHTML = '<h1>Risk Not Found</h1><p><a href="#/">Back to homepage</a></p>';
                    return;
                }

                const risk = riskDoc.data();

                // Generate tags HTML
                let tagsHtml = '';
                if (risk.tags && risk.tags.length > 0) {
                    tagsHtml = '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e1e8ed;"><strong>Tags:</strong> ';
                    tagsHtml += risk.tags.map(tag => `<a href="#/tag/${encodeURIComponent(tag)}" style="display: inline-block; background: #f0f0f0; padding: 4px 10px; margin: 0 5px 5px 0; border-radius: 3px; text-decoration: none; color: #333;">${tag}</a>`).join('');
                    tagsHtml += '</div>';
                }

                let html = `
                    <div class="risk-page">
                        <p><a href="#/">← Back to all risks</a></p>
                        <header>
                            <h1>${risk.title}</h1>
                            ${currentUser ? `<p style="text-align: right;"><a href="#/risk/${riskId}/edit">Edit this risk</a></p>` : ''}
                        </header>
                        <div class="risk-content">
                            ${marked.parse(formatMarkdown(risk.content))}
                        </div>
                        ${tagsHtml}
                    </div>
                `;

                contentDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading risk:', error);
                contentDiv.innerHTML = '<p>Error loading risk. Check console for details.</p>';
            }
        }

        // Edit risk page
        async function showEditRisk(contentDiv, riskId) {
            if (!currentUser) {
                contentDiv.innerHTML = '<p>Please login to edit risks. <a href="#/">Back to homepage</a></p>';
                return;
            }

            contentDiv.innerHTML = '<p>Loading...</p>';

            try {
                const riskDoc = await getDoc(doc(db, 'risks', riskId));
                if (!riskDoc.exists()) {
                    contentDiv.innerHTML = '<h1>Risk Not Found</h1><p><a href="#/">Back to homepage</a></p>';
                    return;
                }

                const risk = riskDoc.data();

                const tagsValue = risk.tags ? risk.tags.join(', ') : '';

                contentDiv.innerHTML = `
                    <div class="edit-page">
                        <p><a href="#/risk/${riskId}">← Cancel</a></p>
                        <h1>Edit Risk</h1>
                        <label>Title:</label>
                        <input type="text" id="risk-title" value="${risk.title}" style="width: 100%; padding: 8px; margin-bottom: 10px; font-size: 16px;">
                        <label>Content:</label>
                        <textarea id="risk-content"></textarea>
                        <label>Tags (comma-separated):</label>
                        <input type="text" id="risk-tags" value="${tagsValue}" placeholder="e.g., technical, coordination" style="width: 100%; padding: 8px; margin-bottom: 10px; margin-top: 10px;">
                        <button id="save-btn" style="margin-top: 10px; padding: 10px 20px; font-size: 16px;">Save Changes</button>
                        <p id="save-status" style="margin-top: 10px;"></p>
                    </div>
                `;

                // Initialize EasyMDE
                editor = new EasyMDE({
                    element: document.getElementById('risk-content'),
                    initialValue: risk.content,
                    spellChecker: false
                });

                document.getElementById('save-btn').addEventListener('click', async () => {
                    const title = document.getElementById('risk-title').value;
                    const content = editor.value();
                    const tagsInput = document.getElementById('risk-tags').value.trim();
                    const saveStatus = document.getElementById('save-status');

                    try {
                        saveStatus.textContent = 'Saving...';

                        // Parse tags
                        const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

                        // Save to version history
                        await addDoc(collection(db, 'risks', riskId, 'history'), {
                            title: risk.title,
                            content: risk.content,
                            tags: risk.tags,
                            editedBy: currentUser.email,
                            editedAt: serverTimestamp()
                        });

                        // Update risk
                        await setDoc(doc(db, 'risks', riskId), {
                            ...risk,
                            title: title,
                            content: content,
                            tags: tags,
                            updatedAt: serverTimestamp(),
                            lastEditedBy: currentUser.email
                        });

                        saveStatus.textContent = 'Saved successfully!';
                        saveStatus.style.color = 'green';
                        setTimeout(() => {
                            window.location.hash = `/risk/${riskId}`;
                        }, 1000);
                    } catch (error) {
                        saveStatus.textContent = `Error: ${error.message}`;
                        saveStatus.style.color = 'red';
                    }
                });
            } catch (error) {
                console.error('Error loading risk for editing:', error);
                contentDiv.innerHTML = '<p>Error loading risk. Check console for details.</p>';
            }
        }

        // Edit homepage
        async function showEditHomepage(contentDiv) {
            if (!currentUser) {
                contentDiv.innerHTML = '<p>Please login to edit the homepage. <a href="#/">Back to homepage</a></p>';
                return;
            }

            contentDiv.innerHTML = '<p>Loading...</p>';

            try {
                // Get or create homepage document
                const homepageDoc = await getDoc(doc(db, 'pages', 'homepage'));
                let homepage = {
                    introduction: 'There are so many causes or sources of AI risk that it\'s getting hard to keep them all in mind. I propose we keep a list of the main sources (that we know about), such that we can say that if none of these things happen, then we\'ve mostly eliminated AI risk (as an existential risk) at least as far as we can determine.'
                };

                if (homepageDoc.exists()) {
                    homepage = homepageDoc.data();
                }

                contentDiv.innerHTML = `
                    <div class="edit-page">
                        <p><a href="#/">← Cancel</a></p>
                        <h1>Edit Homepage</h1>
                        <label>Introduction Text:</label>
                        <textarea id="homepage-content"></textarea>
                        <button id="save-btn" style="margin-top: 10px; padding: 10px 20px; font-size: 16px;">Save Changes</button>
                        <p id="save-status" style="margin-top: 10px;"></p>
                    </div>
                `;

                // Initialize EasyMDE
                editor = new EasyMDE({
                    element: document.getElementById('homepage-content'),
                    initialValue: homepage.introduction,
                    spellChecker: false
                });

                document.getElementById('save-btn').addEventListener('click', async () => {
                    const content = editor.value();
                    const saveStatus = document.getElementById('save-status');

                    try {
                        saveStatus.textContent = 'Saving...';

                        // Save to version history
                        if (homepageDoc.exists()) {
                            await addDoc(collection(db, 'pages', 'homepage', 'history'), {
                                introduction: homepage.introduction,
                                editedBy: currentUser.email,
                                editedAt: serverTimestamp()
                            });
                        }

                        // Update homepage
                        await setDoc(doc(db, 'pages', 'homepage'), {
                            introduction: content,
                            updatedAt: serverTimestamp(),
                            lastEditedBy: currentUser.email
                        });

                        saveStatus.textContent = 'Saved successfully!';
                        saveStatus.style.color = 'green';
                        setTimeout(() => {
                            window.location.hash = '/';
                        }, 1000);
                    } catch (error) {
                        saveStatus.textContent = `Error: ${error.message}`;
                        saveStatus.style.color = 'red';
                    }
                });
            } catch (error) {
                console.error('Error loading homepage for editing:', error);
                contentDiv.innerHTML = '<p>Error loading homepage. Check console for details.</p>';
            }
        }

        // New risk page
        async function showNewRisk(contentDiv) {
            if (!currentUser) {
                contentDiv.innerHTML = '<p>Please login to create new risks. <a href="#/">Back to homepage</a></p>';
                return;
            }

            contentDiv.innerHTML = `
                <div class="edit-page">
                    <p><a href="#/">← Cancel</a></p>
                    <h1>Create New Risk</h1>
                    <label>Title:</label>
                    <input type="text" id="risk-title" placeholder="Enter risk title" style="width: 100%; padding: 8px; margin-bottom: 10px; font-size: 16px;">
                    <label>Content:</label>
                    <textarea id="risk-content"></textarea>
                    <label>Tags (comma-separated):</label>
                    <input type="text" id="risk-tags" placeholder="e.g., technical, coordination" style="width: 100%; padding: 8px; margin-bottom: 10px; margin-top: 10px;">
                    <button id="save-btn" style="margin-top: 10px; padding: 10px 20px; font-size: 16px;">Create Risk</button>
                    <p id="save-status" style="margin-top: 10px;"></p>
                </div>
            `;

            // Initialize EasyMDE
            editor = new EasyMDE({
                element: document.getElementById('risk-content'),
                placeholder: 'Describe the AI risk...',
                spellChecker: false
            });

            document.getElementById('save-btn').addEventListener('click', async () => {
                const title = document.getElementById('risk-title').value.trim();
                const content = editor.value().trim();
                const tagsInput = document.getElementById('risk-tags').value.trim();
                const saveStatus = document.getElementById('save-status');

                if (!title) {
                    saveStatus.textContent = 'Please enter a title';
                    saveStatus.style.color = 'red';
                    return;
                }

                if (!content) {
                    saveStatus.textContent = 'Please enter content';
                    saveStatus.style.color = 'red';
                    return;
                }

                try {
                    saveStatus.textContent = 'Creating...';
                    saveStatus.style.color = 'black';

                    // Parse tags
                    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

                    // Get current risks to determine next order number
                    const risksSnapshot = await getDocs(collection(db, 'risks'));
                    let maxOrder = 0;
                    risksSnapshot.forEach((doc) => {
                        const risk = doc.data();
                        if (risk.order > maxOrder) {
                            maxOrder = risk.order;
                        }
                    });

                    const newOrder = maxOrder + 1;
                    const newRiskId = `risk-${newOrder}`;

                    // Create new risk
                    await setDoc(doc(db, 'risks', newRiskId), {
                        order: newOrder,
                        title: title,
                        content: content,
                        tags: tags,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        createdBy: currentUser.email,
                        lastEditedBy: currentUser.email
                    });

                    saveStatus.textContent = 'Created successfully!';
                    saveStatus.style.color = 'green';
                    setTimeout(() => {
                        window.location.hash = `/risk/${newRiskId}`;
                    }, 1000);
                } catch (error) {
                    saveStatus.textContent = `Error: ${error.message}`;
                    saveStatus.style.color = 'red';
                }
            });
        }

        // Show tag page
        async function showTagPage(contentDiv, tag) {
            contentDiv.innerHTML = '<p>Loading risks...</p>';

            try {
                const risksSnapshot = await getDocs(collection(db, 'risks'));
                const risks = [];

                risksSnapshot.forEach((doc) => {
                    const risk = { id: doc.id, ...doc.data() };
                    // Filter risks that have this tag
                    if (risk.tags && risk.tags.includes(tag)) {
                        risks.push(risk);
                    }
                });

                // Sort by order
                risks.sort((a, b) => a.order - b.order);

                let html = `
                    <div class="tag-page">
                        <p><a href="#/">← Back to all risks</a></p>
                        <header>
                            <h1>Risks tagged: ${tag}</h1>
                            <p style="color: #666; margin-top: 10px;">${risks.length} risk${risks.length !== 1 ? 's' : ''} found</p>
                        </header>

                        <section class="risk-list" style="margin-top: 30px;">
                            <ol class="risks">
                `;

                risks.forEach(risk => {
                    html += `
                        <li class="risk-item">
                            <a href="#/risk/${risk.id}">${risk.title}</a>
                        </li>
                    `;
                });

                html += `
                            </ol>
                        </section>
                    </div>
                `;

                contentDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading tag page:', error);
                contentDiv.innerHTML = '<p>Error loading risks. Check console for details.</p>';
            }
        }

        // Initialize router
        window.addEventListener('hashchange', route);
        route();
    </script>
</body>
</html>
